{% extends "base.html" %}

{% block title %}Batch Upload - Motor Fault Detection{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">Motor Fault Detection System - Batch Processing</h1>
    </div>
    <div class="card-body">
        <p>Upload multiple audio files (up to {{ max_files }} files) for comprehensive motor fault analysis. 
           Our system will process each file individually and provide organized results with:</p>
        
        <ul style="margin: 20px 0; padding-left: 20px;">
            <li><strong>Individual spectrogram folders</strong> for each audio file</li>
            <li><strong>Combined feature analysis</strong> in CSV and JSON formats</li>
            <li><strong>ZIP download</strong> of all spectrograms organized by filename</li>
            <li><strong>Real-time progress tracking</strong> during batch processing</li>
        </ul>
    </div>
</div>

{% if error %}
<div class="alert alert-danger">
    {{ error }}
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Upload Audio Files</h2>
    </div>
    <div class="card-body">
        <form id="upload-form" action="{{ url_for('upload_files') }}" method="post" enctype="multipart/form-data" class="upload-form">
            <div class="file-input-wrapper">
                <input type="file" 
                       id="file-input" 
                       name="files" 
                       accept=".wav,.mp3,.flac,.m4a,.ogg" 
                       class="file-input" 
                       multiple 
                       required>
                <label for="file-input" class="file-input-label">
                    üìÅ Choose Audio Files (Multiple)
                </label>
            </div>
            
            <div id="file-info" class="file-info" style="display: none;"></div>
            
            <p style="margin-top: 15px; color: var(--secondary-color); font-size: 0.9rem;">
                Supported formats: WAV, MP3, FLAC, M4A, OGG<br>
                Maximum {{ max_files }} files per session ‚Ä¢ Maximum 100MB per file
            </p>
            
            <button type="submit" class="btn btn-primary" id="upload-btn" style="margin-top: 15px;" disabled>
                üöÄ Start Batch Analysis
            </button>
        </form>
        
        {% if session.get('session_id') %}
        <div style="margin-top: 30px; text-align: center;">
            <form action="{{ url_for('clear_results') }}" method="post" style="display: inline;">
                <button type="submit" id="clear-btn" class="btn btn-danger">
                    üóëÔ∏è Clear All Results
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<!-- Batch Processing Features -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Batch Processing Features</h2>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div style="padding: 20px; background-color: var(--light-color); border-radius: 8px;">
                <h3 style="color: var(--primary-color); margin-bottom: 10px;">üìä Organized Results</h3>
                <p>Each audio file gets its own folder containing all 6 spectrogram types. Results are clearly organized and easy to navigate.</p>
            </div>
            
            <div style="padding: 20px; background-color: var(--light-color); border-radius: 8px;">
                <h3 style="color: var(--primary-color); margin-bottom: 10px;">üìà Combined Analysis</h3>
                <p>Download all extracted features in a single CSV or JSON file for comprehensive comparative analysis across all uploaded files.</p>
            </div>
            
            <div style="padding: 20px; background-color: var(--light-color); border-radius: 8px;">
                <h3 style="color: var(--primary-color); margin-bottom: 10px;">üì¶ ZIP Downloads</h3>
                <p>Get all spectrograms in a convenient ZIP file with folders named after your original filenames for easy identification.</p>
            </div>
            
            <div style="padding: 20px; background-color: var(--light-color); border-radius: 8px;">
                <h3 style="color: var(--primary-color); margin-bottom: 10px;">‚è±Ô∏è Progress Tracking</h3>
                <p>Real-time progress updates show which files are being processed and overall completion status.</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file-input');
    const fileInfo = document.getElementById('file-info');
    const uploadBtn = document.getElementById('upload-btn');
    
    fileInput.addEventListener('change', function(event) {
        const files = event.target.files;
        
        if (files.length > 0) {
            let totalSize = 0;
            let fileList = [];
            
            for (let i = 0; i < files.length; i++) {
                totalSize += files[i].size;
                fileList.push(`${files[i].name} (${formatFileSize(files[i].size)})`);
            }
            
            fileInfo.innerHTML = `
                <strong>Selected files:</strong> ${files.length} files<br>
                <strong>Total size:</strong> ${formatFileSize(totalSize)}<br>
                <div style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                    ${fileList.map(file => `‚Ä¢ ${file}`).join('<br>')}
                </div>
            `;
            fileInfo.style.display = 'block';
            uploadBtn.disabled = false;
            
            // Validate file count
            if (files.length > {{ max_files }}) {
                fileInfo.innerHTML += '<br><span style="color: var(--danger-color);">‚ö†Ô∏è Too many files selected!</span>';
                uploadBtn.disabled = true;
            }
        } else {
            fileInfo.style.display = 'none';
            uploadBtn.disabled = true;
        }
    });
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
});
</script>
{% endblock %}
