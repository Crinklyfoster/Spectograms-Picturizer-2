{% extends "base.html" %}

{% block title %}Batch Upload - Motor Fault Detection{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">Motor Fault Detection - Batch Processing</h1>
    </div>
    <div class="card-body">
        <p>Upload audio files (1 to {{ max_files }} files) for comprehensive motor fault analysis through our batch processing system.</p>
        
        <ul style="margin: 20px 0; padding-left: 20px;">
            <li><strong>Single or Multiple Files:</strong> Both handled through batch processing</li>
            <li><strong>Six Spectrogram Types:</strong> Complete fault analysis for each file</li>
            <li><strong>Organized Results:</strong> Separate folder for each file's spectrograms</li>
            <li><strong>Combined Downloads:</strong> CSV/JSON for all features, ZIP for all images</li>
        </ul>
    </div>
</div>

{% if error %}
<div class="alert alert-danger">
    {{ error }}
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Upload Audio Files</h2>
    </div>
    <div class="card-body">
        <form id="upload-form" action="{{ url_for('upload_files') }}" method="post" enctype="multipart/form-data" class="upload-form">
            <div class="file-input-wrapper">
                <input type="file" 
                       id="file-input" 
                       name="files" 
                       accept=".wav,.mp3,.flac,.m4a,.ogg" 
                       class="file-input" 
                       multiple 
                       required>
                <label for="file-input" class="file-input-label">
                    üìÅ Choose Audio Files (1 or Multiple)
                </label>
            </div>
            
            <div id="file-info" class="file-info" style="display: none;"></div>
            
            <button type="submit" class="btn btn-primary" id="upload-btn" disabled style="margin-top: 15px;">
                üöÄ Start Batch Processing
            </button>
            
            <p style="margin-top: 15px; color: var(--secondary-color); font-size: 0.9rem;">
                Supported formats: WAV, MP3, FLAC, M4A, OGG<br>
                Maximum {{ max_files }} files per session ‚Ä¢ Up to 100MB per file
            </p>
        </form>
        
        {% if session.get('session_id') %}
        <div style="margin-top: 30px; text-align: center;">
            <form action="{{ url_for('clear_results') }}" method="post" style="display: inline;">
                <button type="submit" id="clear-btn" class="btn btn-danger">
                    üóëÔ∏è Clear All Results
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file-input');
    const fileInfo = document.getElementById('file-info');
    const uploadBtn = document.getElementById('upload-btn');
    
    fileInput.addEventListener('change', function(event) {
        const files = event.target.files;
        
        if (files.length > 0) {
            let totalSize = 0;
            let fileList = [];
            let validFiles = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const isValid = validateAudioFile(file);
                
                if (isValid) {
                    validFiles++;
                    totalSize += file.size;
                    fileList.push(`‚úÖ ${file.name} (${formatFileSize(file.size)})`);
                } else {
                    fileList.push(`‚ùå ${file.name} (Invalid format or too large)`);
                }
            }
            
            fileInfo.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Selected:</strong> ${files.length} files | <strong>Valid:</strong> ${validFiles} files<br>
                    <strong>Total size:</strong> ${formatFileSize(totalSize)}
                </div>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px;">
                    ${fileList.join('<br>')}
                </div>
            `;
            
            fileInfo.style.display = 'block';
            uploadBtn.disabled = validFiles === 0 || validFiles > {{ max_files }};
            
            if (validFiles > {{ max_files }}) {
                fileInfo.innerHTML += '<br><span style="color: var(--danger-color); font-weight: bold;">‚ö†Ô∏è Too many files!</span>';
            } else if (validFiles > 0) {
                fileInfo.innerHTML += '<br><span style="color: var(--success-color); font-weight: bold;">‚úÖ Ready for processing!</span>';
            }
        } else {
            fileInfo.style.display = 'none';
            uploadBtn.disabled = true;
        }
    });
    
    function validateAudioFile(file) {
        const allowedExtensions = ['wav', 'mp3', 'flac', 'm4a', 'ogg'];
        const maxSize = 100 * 1024 * 1024; // 100MB
        
        const extension = file.name.split('.').pop().toLowerCase();
        return allowedExtensions.includes(extension) && file.size <= maxSize;
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
});
</script>
{% endblock %}
