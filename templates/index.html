{% extends "base.html" %}

{% block title %}Motor Fault Detection - Upload{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">Motor Fault Detection System</h1>
    </div>
    <div class="card-body">
        <p>Upload audio files from motors for comprehensive fault analysis. Choose between single file or batch processing:</p>
        
        <ul style="margin: 20px 0; padding-left: 20px;">
            <li><strong>Single File Mode:</strong> Quick analysis of one audio file</li>
            <li><strong>Batch Mode:</strong> Process up to {{ max_files }} files with organized results</li>
            <li><strong>Six Spectrogram Types:</strong> Comprehensive fault detection</li>
            <li><strong>Feature Extraction:</strong> 50+ analytical features</li>
        </ul>
    </div>
</div>

{% if error %}
<div class="alert alert-danger">
    {{ error }}
</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Upload Audio Files</h2>
    </div>
    <div class="card-body">
        <!-- Single File Upload -->
        <div class="upload-mode">
            <h3>Single File Upload</h3>
            <form id="single-upload-form" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="file-input-wrapper">
                    <input type="file" 
                           id="single-file-input" 
                           name="file" 
                           accept=".wav,.mp3,.flac,.m4a,.ogg" 
                           class="file-input">
                    <label for="single-file-input" class="file-input-label">
                        üìÅ Choose Single Audio File
                    </label>
                </div>
                
                <div id="single-file-info" class="file-info" style="display: none;"></div>
                
                <button type="submit" class="btn btn-primary" id="single-upload-btn" disabled>
                    üîç Analyze Single File
                </button>
            </form>
        </div>

        <div style="margin: 30px 0; text-align: center; color: var(--secondary-color);">
            <strong>‚Äî OR ‚Äî</strong>
        </div>

        <!-- Batch Upload -->
        <div class="upload-mode">
            <h3>Batch Upload (Multiple Files)</h3>
            <form id="batch-upload-form" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="file-input-wrapper">
                    <input type="file" 
                           id="batch-file-input" 
                           name="files" 
                           accept=".wav,.mp3,.flac,.m4a,.ogg" 
                           class="file-input" 
                           multiple>
                    <label for="batch-file-input" class="file-input-label">
                        üìÅ Choose Multiple Audio Files
                    </label>
                </div>
                
                <div id="batch-file-info" class="file-info" style="display: none;"></div>
                
                <button type="submit" class="btn btn-success" id="batch-upload-btn" disabled>
                    üöÄ Start Batch Analysis
                </button>
            </form>
        </div>
        
        <p style="margin-top: 20px; color: var(--secondary-color); font-size: 0.9rem; text-align: center;">
            Supported formats: WAV, MP3, FLAC, M4A, OGG<br>
            Single file: up to 100MB ‚Ä¢ Batch: up to {{ max_files }} files per session
        </p>
        
        {% if session.get('session_id') %}
        <div style="margin-top: 30px; text-align: center;">
            <form action="{{ url_for('clear_results') }}" method="post" style="display: inline;">
                <button type="submit" id="clear-btn" class="btn btn-danger">
                    üóëÔ∏è Clear All Results
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<style>
.upload-mode {
    padding: 20px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    margin: 20px 0;
    background-color: var(--light-color);
}

.upload-mode h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    text-align: center;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Single file handling
    const singleFileInput = document.getElementById('single-file-input');
    const singleFileInfo = document.getElementById('single-file-info');
    const singleUploadBtn = document.getElementById('single-upload-btn');
    
    singleFileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            singleFileInfo.innerHTML = `
                <strong>Selected:</strong> ${file.name}<br>
                <strong>Size:</strong> ${formatFileSize(file.size)}
            `;
            singleFileInfo.style.display = 'block';
            singleUploadBtn.disabled = false;
        } else {
            singleFileInfo.style.display = 'none';
            singleUploadBtn.disabled = true;
        }
    });
    
    // Batch file handling
    const batchFileInput = document.getElementById('batch-file-input');
    const batchFileInfo = document.getElementById('batch-file-info');
    const batchUploadBtn = document.getElementById('batch-upload-btn');
    
    batchFileInput.addEventListener('change', function() {
        const files = this.files;
        if (files.length > 0) {
            let totalSize = 0;
            let fileList = [];
            
            for (let i = 0; i < files.length; i++) {
                totalSize += files[i].size;
                fileList.push(`‚Ä¢ ${files[i].name} (${formatFileSize(files[i].size)})`);
            }
            
            batchFileInfo.innerHTML = `
                <strong>Selected files:</strong> ${files.length}<br>
                <strong>Total size:</strong> ${formatFileSize(totalSize)}<br>
                <div style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                    ${fileList.join('<br>')}
                </div>
            `;
            batchFileInfo.style.display = 'block';
            batchUploadBtn.disabled = files.length > {{ max_files }};
            
            if (files.length > {{ max_files }}) {
                batchFileInfo.innerHTML += '<br><span style="color: var(--danger-color);">‚ö†Ô∏è Too many files!</span>';
            }
        } else {
            batchFileInfo.style.display = 'none';
            batchUploadBtn.disabled = true;
        }
    });
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
});
</script>
{% endblock %}
